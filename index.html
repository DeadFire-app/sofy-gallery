<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>cat√°logo sofy mdn</title>
  <meta name="description" content="sofy mdn ‚Äî cat√°logo de reventa con galer√≠a vertical, paginaci√≥n, b√∫squeda y carrito." />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="./styles.css" />
</head>
<body>
  <!-- Splash: loader circular + t√≠tulo + siluetas -->
  <div id="splash" class="splash" aria-hidden="true">
    <div class="splash-ambient" aria-hidden="true"></div>

    <div class="silhouettes" aria-hidden="true">
      <div class="sil sil-hanger" style="--x:10%; --delay:0s;   --sz:1;"></div>
      <div class="sil sil-shirt"  style="--x:22%; --delay:.4s;  --sz:1.1;"></div>
      <div class="sil sil-dress"  style="--x:36%; --delay:.8s;  --sz:.95;"></div>
      <div class="sil sil-bag"    style="--x:48%; --delay:1.1s; --sz:1.05;"></div>
      <div class="sil sil-tag"    style="--x:62%; --delay:.2s;  --sz:.9;"></div>
      <div class="sil sil-hanger" style="--x:75%; --delay:.6s;  --sz:1.15;"></div>
      <div class="sil sil-shirt"  style="--x:88%; --delay:1.4s; --sz:1;"></div>
      <div class="sil sil-dress only-desktop" style="--x:5%;  --delay:1.2s; --sz:.9;"></div>
      <div class="sil sil-bag   only-desktop" style="--x:94%; --delay:.9s;  --sz:1.1;"></div>
    </div>

    <div class="splash-core">
      <svg class="ring" viewBox="0 0 120 120" aria-hidden="true">
        <circle class="track" cx="60" cy="60" r="46" />
        <circle class="spin"  cx="60" cy="60" r="46" />
        <circle class="pulse" cx="60" cy="60" r="22" />
      </svg>
      <h1 class="splash-title"><span>sofy</span> mdn</h1>
      <div class="splash-sub">cat√°logo de reventa</div>
    </div>
  </div>

  <!-- Fondo suave (detr√°s del contenido) -->
  <div class="bg-animated" aria-hidden="true"></div>

  <!-- --- CART PANEL (side-menu) ------------------------------------------------ -->
  <!-- Debe estar antes del men√∫ en el DOM para que document.querySelector('.side-menu') lo abra -->
  <aside id="cartPanel" class="side-menu" role="dialog" aria-label="Carrito de compras" aria-hidden="true">
    <button class="close-menu" id="closeCartPanel" aria-label="Cerrar carrito">√ó</button>
    <div class="cart-header" style="padding:14px 16px;display:flex;align-items:center;justify-content:space-between;">
      <div style="font-weight:700">Tu carrito</div>
      <div class="muted" id="cartCount" aria-live="polite">0 items</div>
    </div>

    <div class="cart-body" id="cartItems" tabindex="0" aria-live="polite">
      <!-- items renderizados por JS -->
      <p style="color:var(--muted)">No hay productos a√∫n.</p>
    </div>

    <div class="cart-footer" style="padding:12px 16px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div>Total:</div><div>$<span id="cartTotal">0</span> ARS</div>
      </div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <div>Se√±a 50%:</div><div>$<span id="cartDeposit">0</span> ARS</div>
      </div>
      <a id="payLink" href="#" target="_blank" rel="noopener" class="primary-btn" style="display:block;text-align:center">Pagar con Mercado Pago</a>

      <!-- Nuevo: bot√≥n para abrir modal de comprobante -->
      <button id="openReceiptBtn" class="primary-btn" style="margin-top:8px;display:block;text-align:center">Enviar comprobante</button>

      <p class="note small" style="margin-top:10px;color:var(--muted)">
        Luego de pagar, si Mercado Pago te redirige a este sitio, se te abrir√° un formulario para subir el comprobante.
        Tambi√©n pod√©s enviarlo desde aqu√≠ con el bot√≥n "Enviar comprobante".
      </p>
    </div>
  </aside>
  <!-- --------------------------------------------------------------------------- -->

  <header class="container header">
    <h1 class="title">cat√°logo <span>sofy mdn</span></h1>

    <div class="controls">
      <!-- Men√∫ -->
      <button id="hamburger" class="icon-btn" aria-label="Men√∫">
        <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M3 6h18v2H3zM3 11h18v2H3zM3 16h18v2H3z"/></svg>
      </button>

      <!-- B√∫squeda -->
      <label class="search-wrap">
        <input id="searchInput" type="search" placeholder="Buscar: algodon remera negra‚Ä¶" aria-label="Buscar productos" />
        <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
          <path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16a6.471 6.471 0 0 0 4.23-1.57l.27.28v.79L20 21.5 21.5 20l-6-6zM4 9.5C4 6.46 6.46 4 9.5 4S15 6.46 15 9.5 12.54 15 9.5 15 4 12.54 4 9.5z"></path>
        </svg>
      </label>

      <span id="countInfo" class="count-info" aria-live="polite"></span>

      <!-- Carrito (abre el panel lateral) -->
      <button id="btnCart" class="icon-btn" aria-label="Carrito">
        <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M7 18a2 2 0 1 0 .001 3.999A2 2 0 0 0 7 18zm10 0a2 2 0 1 0 .001 3.999A2 2 0 0 0 17 18zM7.16 14h9.53c.75 0 1.41-.41 1.75-1.03l3.58-6.49A1 1 0 0 0 21.18 5H6.21L5.27 3H2v2h2l3.6 7.59L5.25 14h1.91z"/></svg>
      </button>
    </div>
  </header>

  <!-- Men√∫ hamburguesa (usa el id sideMenu que el JS espera) -->
  <nav id="sideMenu" class="side-menu" aria-hidden="true" role="navigation" aria-label="Men√∫ principal">
    <button class="close-menu" id="closeMenu" aria-label="Cerrar men√∫">√ó</button>
    <ul>
      <li><button class="menu-link" data-section="bienvenida">üå∑ ¬°Bienvenida a Sofy mdn!</button></li>
      <li><button class="menu-link" data-section="quienes">üíï Qui√©nes somos</button></li>
      <li><button class="menu-link" data-section="revendedora">üëó C√≥mo empezar a ser revendedora</button></li>
      <li><button class="menu-link" data-section="faq">üéÄ Preguntas frecuentes</button></li>
      <li><button class="menu-link" data-section="soporte">üëõ Soporte y contacto</button></li>
      <li><button class="menu-link" data-section="unite">‚ú® Unite, vend√©, crec√©</button></li>
    </ul>
    <div id="menuContent" class="menu-content" tabindex="0"></div>
  </nav>

  <main class="container">
    <section id="gallery" class="grid" aria-live="polite">
        <!-- Indicador de carga inicial (se remueve al cargar) -->
        <div id="gallery-loading" style="grid-column: 1 / -1; text-align: center; padding: 20px;">
            Cargando productos...
        </div>
        <!-- Productos inyectados por el nuevo script -->
    </section>
    <nav id="pagination" class="pagination" aria-label="Paginaci√≥n"></nav>
  </main>

  <footer class="container footer">
    <small>¬© <span id="year"></span> sofy mdn ‚Äî hecho a mano.</small>
  </footer>

  <!-- Modal Detalle (actualizado con Nexora thumbs + talles) -->
  <dialog id="detailModal" class="info-modal" aria-modal="true" aria-label="Detalle del producto">
    <button class="modal-x" data-close="detail" aria-label="Cerrar detalle">√ó</button>

    <div class="detail-body">
      <!-- IM√ÅGENES + THUMBS -->
      <div id="detailImages" class="slider" aria-live="polite" aria-label="Galer√≠a de im√°genes">
        <!-- slider + thumbs inyectados por JS -->
      </div>

      <!-- INFO / TALLAS -->
      <div class="detail-text">
        <h3 id="detailTitle"></h3>
        <p id="detailDesc"></p>
        <div id="detailTags" class="tags" aria-hidden="false"></div>

        <div id="detailSizes" aria-label="Talles disponibles" style="margin-top:12px;">
          <!-- talles inyectados por JS (botones .size-btn) -->
        </div>

        <div class="detail-actions" style="margin-top:14px;">
          <button id="addToCart" class="primary-btn" aria-label="Agregar al carrito">Agregar al carrito</button>
        </div>
      </div>
    </div>
  </dialog>

  <!-- Modal / Dialog: Enviar comprobante -->
  <dialog id="receiptModal" class="info-modal" aria-modal="true" aria-label="Enviar comprobante de pago">
    <button class="modal-x" data-close="receipt" aria-label="Cerrar comprobante">√ó</button>

    <div class="detail-body" style="max-width:760px;">
      <h3 style="margin-top:0">Enviar comprobante de pago</h3>
      <p>Adjunt√° el comprobante (imagen o PDF) y complet√° tus datos. Luego confirm√° para enviar.</p>

      <form id="receiptForm">
        <div style="margin-bottom:10px;">
          <label for="receiptFile">Comprobante (imagen / PDF)</label><br>
          <input id="receiptFile" name="receipt" type="file" accept="image/*,application/pdf" required>
        </div>

        <div style="margin-bottom:10px;">
          <label for="receiptName">Nombre completo</label><br>
          <input id="receiptName" name="name" type="text" placeholder="Nombre y apellido" required>
        </div>

        <div style="display:flex;gap:12px;margin-bottom:10px;">
          <div style="flex:1">
            <label for="receiptPhone">Tel√©fono</label><br>
            <input id="receiptPhone" name="phone" type="text" placeholder="11-1234-5678" required>
          </div>
          <div style="flex:1">
            <label for="receiptEmail">Email</label><br>
            <input id="receiptEmail" name="email" type="email" placeholder="tu@correo.com" required>
          </div>
        </div>

        <div id="receiptMsg" role="status" aria-live="polite" style="min-height:1.2em;margin-bottom:8px;color:var(--muted)"></div>

        <div style="display:flex;gap:8px;align-items:center;margin-top:6px;">
          <button id="receiptSendBtn" type="button" class="primary-btn">Enviar comprobante</button>
          <button type="button" id="receiptCancelBtn" class="muted-btn">Cancelar</button>
        </div>
      </form>
    </div>
  </dialog>

  <noscript>
    <div class="container" style="margin:1rem auto;color:#e91e63">
      Necesit√°s habilitar JavaScript para ver el cat√°logo.
    </div>
  </noscript>

  <script src="./app.js" defer></script>

  <!-- L√≥gica de interacciones UI existente (copia del original) -->
  <script>
    // small glue: cerrar panel carrito y menu cuando presionan sus botones de cerrar
    document.addEventListener('DOMContentLoaded', ()=>{
      document.getElementById('btnCart')?.addEventListener('click', ()=> {
        // abrir el primer .side-menu (nuestro cartPanel que est√° arriba en el DOM)
        document.querySelector('.side-menu')?.classList.add('open');
      });
      document.getElementById('closeCartPanel')?.addEventListener('click', ()=> {
        document.querySelector('.side-menu')?.classList.remove('open');
      });

      // cerrar menu (bindMenu en app.js tambi√©n lo gestiona; esto es seguro)
      document.getElementById('closeMenu')?.addEventListener('click', ()=> {
        document.getElementById('sideMenu')?.classList.remove('open');
      });

      // cerrar modal detail (ya lo maneja el JS, pero dejamos el binding para el bot√≥n)
      document.querySelectorAll('.modal-x').forEach(x=>{
        x.addEventListener('click', (e)=>{
          const t = e.currentTarget.dataset.close;
          if (t==='detail') document.getElementById('detailModal')?.close?.();
          if (t==='receipt') document.getElementById('receiptModal')?.close?.();
        });
      });

      // Open receipt modal from button in cart footer
      document.getElementById('openReceiptBtn')?.addEventListener('click', ()=>{
        try { document.getElementById('receiptModal')?.showModal(); } catch(e){ /* fallback */ document.getElementById('receiptModal')?.setAttribute('open',''); }
      });

      // Cancel button inside receipt modal
      document.getElementById('receiptCancelBtn')?.addEventListener('click', ()=>{
        try { document.getElementById('receiptModal')?.close(); } catch(e){ document.getElementById('receiptModal')?.removeAttribute('open'); }
      });

      // Receipt form submit logic
      const receiptForm = document.getElementById('receiptForm');
      const receiptSendBtn = document.getElementById('receiptSendBtn');
      const receiptMsg = document.getElementById('receiptMsg');
      const MAX_BYTES = window.MAX_RECEIPT_BYTES || (20 * 1024 * 1024); // 20MB por defecto

      receiptSendBtn?.addEventListener('click', async ()=>{
        receiptMsg.textContent = '';
        const fileInput = document.getElementById('receiptFile');
        const name = document.getElementById('receiptName').value.trim();
        const phone = document.getElementById('receiptPhone').value.trim();
        const email = document.getElementById('receiptEmail').value.trim();

        if(!fileInput || !fileInput.files || !fileInput.files[0]) { receiptMsg.textContent = 'Seleccion√° un comprobante (imagen o PDF).'; return; }
        if(!name || !phone || !email) { receiptMsg.textContent = 'Complet√° nombre, tel√©fono y email.'; return; }

        const file = fileInput.files[0];
        if(file.size > MAX_BYTES){ receiptMsg.textContent = `El archivo es muy grande (m√°x ${Math.round(MAX_BYTES/1024/1024)} MB).`; return; }

        // Build FormData
        const fd = new FormData();
        fd.append('receipt', file);
        fd.append('name', name);
        fd.append('phone', phone);
        fd.append('email', email);

        // UI state
        receiptSendBtn.disabled = true;
        receiptSendBtn.textContent = 'Enviando...';

        try{
          const res = await fetch('/.netlify/functions/sendReceipt', { method:'POST', body: fd });
          const json = await res.json();
          if(json.ok){
            receiptMsg.style.color = 'green';
            receiptMsg.textContent = '‚úÖ Comprobante enviado. Gracias ‚Äî en breve te confirmaremos.';
            // clear form
            fileInput.value = '';
            document.getElementById('receiptName').value = '';
            document.getElementById('receiptPhone').value = '';
            document.getElementById('receiptEmail').value = '';
            // Close modal after short delay
            setTimeout(()=>{ try{ document.getElementById('receiptModal')?.close(); }catch(e){} }, 900);
          } else {
            receiptMsg.style.color = 'crimson';
            receiptMsg.textContent = 'Error: ' + (json.error || JSON.stringify(json));
          }
        }catch(err){
          receiptMsg.style.color = 'crimson';
          receiptMsg.textContent = 'Error enviando comprobante: ' + err.message;
        }finally{
          receiptSendBtn.disabled = false;
          receiptSendBtn.textContent = 'Enviar comprobante';
        }
      });

      // If the user was redirected from MercadoPago, auto-open the receipt modal.
      // Detect by query param: ?mp_success=1  OR referrer contains 'mercadopago'
      try{
        const urlParams = new URLSearchParams(window.location.search);
        const mpSuccess = urlParams.get('mp_success');
        const ref = document.referrer || '';
        if(mpSuccess === '1' || /mercadopago/i.test(ref) ){
          // open modal and optionally focus file input
          setTimeout(()=>{ try{ document.getElementById('receiptModal')?.showModal(); document.getElementById('receiptFile')?.focus(); }catch(e){ document.getElementById('receiptModal')?.setAttribute('open',''); } }, 500);
        }
      }catch(e){ /* ignore */ }

      // Inicializar la galer√≠a al cargar el DOM, despu√©s de que app.js potencialmente cargue
      loadGallery();
    });
  </script>

  <!-- >>>>>>>>>>>>> NUEVA L√ìGICA DE CARGA DE GALER√çA DESDE GITHUB <<<<<<<<<<<<< -->
  <script>
    // URL RAW de tu archivo data.json en GitHub
    const DATA_URL = 'https://raw.githubusercontent.com/DeadFire-app/sofy-gallery/main/data/data.json';
    
    const galleryContainer = document.getElementById('gallery');
    const loadingIndicator = document.getElementById('gallery-loading'); // Usamos el nuevo div
    const countInfoElement = document.getElementById('countInfo');
    
    // Funci√≥n para crear una tarjeta de producto
    function createProductCard(item) {
        // Aseguramos que la URL de la imagen se tome de 'link' (subida por el bot)
        const imageUrl = item.link || item.imageUrl || item.url; 
        
        if (!imageUrl) return null;

        const card = document.createElement('article');
        // Usamos una clase gen√©rica 'product-card' para que tu styles.css le d√© estilo
        card.className = 'product-card';
        card.setAttribute('data-id', item.id); 

        // Asumimos que los detalles del producto est√°n en el objeto item
        const title = item.caption || `Producto ID: ${item.id}`;
        // Usa un precio de ejemplo si no est√° definido en el JSON
        const price = item.price ? `$${item.price}` : '$2500'; 
        // Asume tags y sizes para que se vea bien, ajusta seg√∫n tu JSON real
        const tags = item.tags ? item.tags.map(tag => `<span class="tag">${tag}</span>`).join('') : '<span class="tag">Nuevo</span>';
        const availableSizes = item.sizes ? item.sizes.join(', ') : 'Talles: S, M, L';
        
        card.innerHTML = `
            <!-- Usamos background-image para mantener la consistencia con tu c√≥digo original -->
            <div class="product-image" style="background-image: url('${imageUrl}');">
            </div>
            <div class="product-info">
                <h4 class="product-title">${title}</h4>
                <div class="product-tags">${tags}</div>
                <div class="product-price">${price}</div>
                <div class="product-sizes muted small">${availableSizes}</div>
                
                <!-- El bot√≥n debe disparar la funci√≥n que tienes en app.js para abrir el modal de detalle -->
                <button class="action-btn" data-action="detail" data-id="${item.id}" aria-label="Ver detalles de ${title}">
                    Ver Detalle
                </button>
            </div>
        `;
        return card;
    }

    // Funci√≥n principal para cargar y renderizar los datos
    async function loadGallery() {
        if (!galleryContainer) return;

        try {
            loadingIndicator.style.display = 'block';
            galleryContainer.innerHTML = ''; // Limpiar cualquier contenido existente

            // Fetch sin cach√© para obtener siempre la √∫ltima versi√≥n de GitHub
            const response = await fetch(DATA_URL, { cache: 'no-store' }); 
            
            if (!response.ok) {
                throw new Error(`Error al obtener data.json: ${response.status} ${response.statusText}`);
            }
            
            const data = await response.json();
            // Filtramos por 'deleted: true' (soft delete)
            const allItems = data.items || [];
            const activeItems = allItems.filter(item => !item.deleted);
            
            if (activeItems.length === 0) {
                galleryContainer.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: var(--muted);">La galer√≠a est√° vac√≠a. Sube una imagen con el bot para empezar.</p>';
            } else {
                activeItems.forEach(item => {
                    const card = createProductCard(item);
                    if (card) {
                        galleryContainer.appendChild(card);
                    }
                });
            }

            countInfoElement.textContent = `${activeItems.length} art√≠culos`;
            
            // Si app.js necesita la lista de productos, la almacenamos globalmente
            window.allProducts = allItems;
            
        } catch (error) {
            console.error('Error al cargar la galer√≠a:', error);
            galleryContainer.innerHTML = `<p style="grid-column: 1 / -1; text-align: center; color: crimson;">ERROR: No se pudo cargar la galer√≠a. Revisa la URL de GitHub en el index.html y la consola.</p>`;
        } finally {
            loadingIndicator.style.display = 'none'; // Ocultar indicador de carga
        }
    }
    
    // Funci√≥n para que app.js pueda refrescar la galer√≠a si es necesario
    window.refreshGallery = loadGallery;
    
    // El app.js (diferido) se ejecutar√° y luego loadGallery() en DOMContentLoaded
  </script>
</body>
</html>

